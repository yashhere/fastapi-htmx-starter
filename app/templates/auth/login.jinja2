{% extends "base.jinja2" %}
{% block title %}
  Login - FastAPI HTMX Starter
{% endblock title %}
{% block content %}
  <div class="max-w-md mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
      <div id="auth-form-messages" class="mb-4"></div>
      <form id="login-form"
            hx-post="/auth/cookie/login"
            hx-target="#auth-form-messages"
            hx-swap="innerHTML"
            class="space-y-4">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email"
                 id="username"
                 name="username"
                 required
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input type="password"
                 id="password"
                 name="password"
                 required
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <button type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
          Login
        </button>
      </form>
      <div class="mt-4 text-center">
        <p class="text-sm text-gray-600">
          Don't have an account?
          <a href="{{ url_for("auth_register_page") }}" class="text-blue-600 hover:text-blue-800">Sign up</a>
        </p>
      </div>
    </div>
  </div>
  <script>
      document.body.addEventListener("htmx:afterOnLoad", function(evt) {
          const xhr = evt.detail.xhr;
          const target = evt.detail.target;

          if (xhr.status === 302 || xhr.status === 200) {
              if (xhr.responseURL && !xhr.responseURL.includes('/auth/')) {
                  // Successful login redirect
                  htmx.trigger(document.body, 'userLoggedIn');
                  window.location.href = xhr.responseURL;
              } else if (target && target.id === 'auth-form-messages') {
                  // Handle form validation errors
                  if (xhr.responseText.includes('error') || xhr.responseText.includes('invalid')) {
                      target.innerHTML = '<div class="text-red-600 text-sm">' + xhr.responseText + '</div>';
                  } else {
                      target.innerHTML = '<div class="text-green-600 text-sm">Login successful!</div>';
                  }

              }
          }
      });
  </script>
{% endblock content %}
